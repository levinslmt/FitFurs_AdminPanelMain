<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Appointments</title>
  <link rel="stylesheet" href="../styles/sidebar.css">
  <link rel="stylesheet" href="../styles/global.css">
  <link rel="stylesheet" href="../styles/users.css">
  <style>
    /* Modal Styles */
    .main {
      margin-left: 280px;      /* SAME AS SIDEBAR WIDTH */
      padding: 20px;
      min-width: 0;
    }

    #editModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: #fff;
      padding: 30px;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      position: relative;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      animation: fadeIn 0.3s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }
    .modal-content h2 {
      margin-top: 0;
      margin-bottom: 20px;
      color: #333;
      font-size: 24px;
    }
    .close-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
      transition: color 0.2s;
    }
    .close-btn:hover {
      color: #000;
    }
    #editForm label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #555;
    }
    #editForm input,
    #editForm select {
      width: 100%;
      padding: 12px;
      margin-bottom: 20px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 16px;
      box-sizing: border-box;
    }
    #editForm input:disabled {
      background-color: #f5f5f5;
      color: #666;
    }
    #editForm input:focus,
    #editForm select:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
    }
    .modal-buttons {
      margin-top: 25px;
      text-align: right;
    }
    .modal-buttons button {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      margin-left: 10px;
      transition: background-color 0.2s;
    }
    #cancelEdit {
      background-color: #6c757d;
      color: white;
    }
    #cancelEdit:hover {
      background-color: #5a6268;
    }
    #editForm button[type="submit"] {
      background-color: #007bff;
      color: white;
    }
    #editForm button[type="submit"]:hover {
      background-color: #0056b3;
    }
  </style>
</head>

<body>
  <div class="container">
    <side-bar></side-bar>

    <div class="main">
      <section id="appointments">
        <h1>Appointments</h1>

        <!-- Controls -->
        <div class="controls">
          <input type="text" id="searchInput" placeholder="Search by pet, owner, or ID...">

          <select id="statusFilter">
            <option value="">All Status</option>
            <option value="Scheduled">Scheduled</option>
            <option value="Completed">Completed</option>
            <option value="Canceled">Canceled</option>
            <option value="No-show">No-show</option>
          </select>

          <select id="typeFilter">
            <option value="">All Types</option>
            <option value="Check Up">Check Up</option>
            <option value="Vaccination">Vaccination</option>
            <option value="Grooming">Grooming</option>
            <option value="Follow-up">Follow-up</option>
            <option value="Emergency">Emergency</option>
          </select>
        </div>

        <!-- Appointments Table -->
        <table id="appointmentsTable">
          <thead>
            <tr>
              <th>Appointment ID</th>
              <th>Pet Name</th>
              <th>Owner Name</th>
              <th>Date</th>
              <th>Time</th>
              <th>Type</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>
    </div>
  </div>

  <!-- EDIT MODAL -->
  <div id="editModal">
    <div class="modal-content">
      <button class="close-btn" id="closeModal">&times;</button>
      <h2>Edit Appointment</h2>

      <form id="editForm">
        <label for="editPetName">Pet Name</label>
        <input id="editPetName" type="text" disabled>

        <label for="editOwnerName">Owner Name</label>
        <input id="editOwnerName" type="text" disabled>

        <label for="editDate">Date</label>
        <input id="editDate" type="date" required>

        <label for="editTime">Time</label>
        <input id="editTime" type="time" required>

        <label for="editType">Type</label>
        <select id="editType" required>
          <option value="Check Up">Check Up</option>
          <option value="Vaccination">Vaccination</option>
          <option value="Grooming">Grooming</option>
          <option value="Follow-up">Follow-up</option>
          <option value="Emergency">Emergency</option>
        </select>

        <label for="editStatus">Status</label>
        <select id="editStatus" required>
          <option value="Scheduled">Scheduled</option>
          <option value="Completed">Completed</option>
          <option value="Canceled">Canceled</option>
          <option value="No-show">No-show</option>
        </select>

        <div class="modal-buttons">
          <button type="button" id="cancelEdit">Cancel</button>
          <button type="submit">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    /* ----------------------------------------------------------
       FIREBASE SETUP
    ----------------------------------------------------------*/
    const firebaseConfig = {
      apiKey: "BOQout55yLWUT_u5i4RUnKn7YWjdEVomWAjCkXz3IvTaVVkeCdDEa1TNOlfwKp_9ywtk9N8_xWSesl1MeJQMJbI",
      authDomain: "fitfurs12.firebaseapp.com",
      projectId: "fitfurs12",
      storageBucket: "fitfurs12.appspot.com",
      messagingSenderId: "875211703765",
      appId: "1:875211703765:android:b069bfa50ec424172c295c"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    /* ----------------------------------------------------------
       ACTIVITY LOGGING FUNCTION
    ----------------------------------------------------------*/
    async function logActivity(type, description, userId = null, petId = null) {
      try {
        await db.collection("activities").add({
          type: type,  // e.g., 'appointment_updated', 'appointment_canceled'
          description: description,  // e.g., 'Appointment for pet Fluffy updated'
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          userId: userId,  // ID of the user (owner)
          petId: petId    // ID of the pet
        });
        console.log(`Activity logged: ${description}`);
      } catch (error) {
        console.error("Error logging activity:", error);
      }
    }

    const tableBody = document.querySelector("#appointmentsTable tbody");
    const searchInput = document.getElementById("searchInput");
    const statusFilter = document.getElementById("statusFilter");
    const typeFilter = document.getElementById("typeFilter");

    // Stores references to each appointment
    let appointmentIndex = [];

    /* ----------------------------------------------------------
       LOAD APPOINTMENTS (Nested)
    ----------------------------------------------------------*/
    async function loadAppointments() {
      tableBody.innerHTML = "";
      appointmentIndex = [];

      const usersSnap = await db.collection("users").get();

      for (let userDoc of usersSnap.docs) {
        const userId = userDoc.id;
        const userData = userDoc.data();
        const ownerName = userData.username || "Unknown";

        const petsSnap = await db.collection("users")
          .doc(userId).collection("pets").get();

        for (let petDoc of petsSnap.docs) {
          const petId = petDoc.id;
          const petData = petDoc.data();

          const appointmentsSnap = await db.collection("users")
            .doc(userId).collection("pets")
            .doc(petId).collection("appointments")
            .get();

          appointmentsSnap.forEach(apptDoc => {
            const appt = apptDoc.data();
            const apptId = apptDoc.id;

            appointmentIndex.push({
              apptId,
              userId,
              petId,
              data: appt,
              petName: petData.petName,
              ownerName: ownerName
            });

            const row = document.createElement("tr");
            row.dataset.index = appointmentIndex.length - 1;

            row.innerHTML = `
              <td>${apptId}</td>
              <td>${petData.petName || ""}</td>
              <td>${ownerName}</td>
              <td>${appt.date}</td>
              <td>${appt.time}</td>
              <td>${appt.reason}</td>
              <td>${appt.status}</td>
              <td>
                <button class="edit-btn">Edit</button>
                <button class="delete-btn">Delete</button>
              </td>
            `;

            tableBody.appendChild(row);
          });
        }
      }
    }

    loadAppointments();

    /* ----------------------------------------------------------
       SEARCH + FILTER
    ----------------------------------------------------------*/
    function filterAppointments() {
      const search = searchInput.value.toLowerCase();
      const filterStatus = statusFilter.value;
      const filterType = typeFilter.value;

      [...tableBody.rows].forEach(row => {
        const petName = row.cells[1].textContent.toLowerCase();
        const ownerName = row.cells[2].textContent.toLowerCase();
        const appointmentId = row.cells[0].textContent.toLowerCase();
        const status = row.cells[6].textContent;
        const type = row.cells[5].textContent;

        const matchSearch =
          petName.includes(search) ||
          ownerName.includes(search) ||
          appointmentId.includes(search);

        const matchStatus = !filterStatus || status === filterStatus;
        const matchType = !filterType || type === filterType;

        row.style.display = (matchSearch && matchStatus && matchType) ? "" : "none";
      });
    }

    searchInput.addEventListener("input", filterAppointments);
    statusFilter.addEventListener("change", filterAppointments);
    typeFilter.addEventListener("change", filterAppointments);

    /* ----------------------------------------------------------
       EDIT / DELETE
    ----------------------------------------------------------*/
    const editModal = document.getElementById("editModal");
    const editForm = document.getElementById("editForm");

    tableBody.addEventListener("click", async (e) => {
      const row = e.target.closest("tr");
      if (!row) return;

      const index = row.dataset.index;
      const apptInfo = appointmentIndex[index];
      const { userId, petId, apptId } = apptInfo;

      // EDIT
      if (e.target.classList.contains("edit-btn")) {
        document.getElementById("editPetName").value = row.cells[1].textContent;
        document.getElementById("editOwnerName").value = row.cells[2].textContent;
        document.getElementById("editDate").value = row.cells[3].textContent;
        document.getElementById("editTime").value = row.cells[4].textContent;
        document.getElementById("editType").value = row.cells[5].textContent;
        document.getElementById("editStatus").value = row.cells[6].textContent;

        editModal.style.display = "flex";

        editForm.onsubmit = async (ev) => {
          ev.preventDefault();

          // Existing update logic
          await db.collection("users")
            .doc(userId).collection("pets")
            .doc(petId).collection("appointments")
            .doc(apptId)
            .update({
              date: document.getElementById("editDate").value,
              time: document.getElementById("editTime").value,
              reason: document.getElementById("editType").value,
              status: document.getElementById("editStatus").value
            });

          // NEW: Log the update activity
          const petName = apptInfo.petName;  // From apptInfo
          const ownerName = apptInfo.ownerName;  // From apptInfo
          await logActivity(
            'appointment_updated',
            `Appointment for pet ${petName} (owned by ${ownerName}) was updated`,
            userId,
            petId
          );

          editModal.style.display = "none";
          loadAppointments();
        };
      }

      // DELETE
      if (e.target.classList.contains("delete-btn")) {
        if (confirm("Delete this appointment?")) {
          // Existing delete logic
          await db.collection("users")
            .doc(userId).collection("pets")
            .doc(petId).collection("appointments")
            .doc(apptId)
            .delete();

          // NEW: Log the delete activity
          const petName = apptInfo.petName;  // From apptInfo
          const ownerName = apptInfo.ownerName;  // From apptInfo
          await logActivity(
            'appointment_canceled',
            `Appointment for pet ${petName} (owned by ${ownerName}) was canceled`,
            userId,
            petId
          );

          loadAppointments();
        }
      }
    });

    // Cancel edit
    document.getElementById("cancelEdit").addEventListener("click", () => {
      editModal.style.display = "none";
    });

    // Close modal on close button click
    document.getElementById('closeModal').addEventListener('click', () => {
      editModal.style.display = 'none';
    });

    // Close modal on outside click
    editModal.addEventListener('click', (e) => {
      if (e.target === editModal) {
        editModal.style.display = 'none';
      }
    });
  </script>
  <script type="module" src="../main.js" defer></script>
</body>
</html>